<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./index.css" />
    <title>charlee</title>
  </head>
  <body>
    <noscript>this app is non-functional without javascript. :(</noscript>

    <nav>
      <div id="nav-title">
        <h1>charlee</h1>
        <div id="nav-links">
          <a href="./faq.html">about this</a>
          <a href="./about.html">about me</a>
        </div>
      </div>
      <div>
        <div id="userslug-container">
          you are:<br /><span id="userslug">...</span>!
        </div>
        <footer
          style="
            position: absolute;
            bottom: 5pt;
            width: 100%;
            text-align: center;
            font-size: 0.8em;
            z-index: 1000;
          "
        >
          <p>Antoni Chmiela, 2025</p>
        </footer>
      </div>
    </nav>

    <main>
      <div id="messages-container"></div>

      <div id="connection-modal">
        <input
          type="text"
          id="peerid-input"
          placeholder="enter peer ID to connect to..."
        />
        <button type="button" id="connect-button" onclick="onConnect()">
          connect
        </button>
      </div>

      <div id="message-input-container">
        <textarea
          type="text"
          id="message-input"
          rows="1"
          placeholder="type your message here..."
        ></textarea>
        <button type="button" id="send-button" onclick="onSendMessage()">
          send
        </button>
      </div>
    </main>
  </body>

  <script type="module">
    import { generateSlug } from "./lib.js";
    import { Peer } from "https://esm.sh/peerjs@1.5.5?bundle-deps";

    // Set up new peer for this tab
    const slug = generateSlug();
    const peer = new Peer(slug);
    document.getElementById("userslug").textContent = peer.id;

    let connection = null;

    // Handle oncoming connections
    peer.on("connection", (conn) => {
      console.log("Incoming connection from:", conn.peer);
      conn.on("data", (data) => {
        console.log("Received:", data);
        document.getElementById("messages-container").innerHTML += `
          <div class="message received">
            <div class="message-sender">${conn.peer}:</div>
            <div class="message-text received">${data.replaceAll(
              "\n",
              "<br/>"
            )}</div>
          </div>
        `;
      });
    });

    function onConnect() {
      const modal = document.getElementById("connection-modal");
      modal.style.display = "none";
      const peerId = document.getElementById("peerid-input").value;
      const conn = peer.connect(peerId);

      conn.on("open", () => {
        console.log("Connected to:", peerId);
        connection = conn;
        document.getElementById("messages-container").innerHTML += `
          <div class="message system">
            <span class="message-text system">talking with ${peerId}!</span>
          </div>
        `;
      });
    }

    function onSendMessage() {
      const messageTextarea = document.getElementById("message-input");
      const message = messageTextarea.value;
      messageTextarea.value = "";

      console.log("sending message:", message);

      if (connection && connection.open) {
        connection.send(message);
        document.getElementById("messages-container").innerHTML += `
          <div class="message sent">
            <div class="message-sender">${peer.id}:</div>
            <div class="message-text sent">${message.replaceAll(
              "\n",
              "<br/>"
            )}</div>
          </div>
        `;
      } else {
        console.log("no open connection to send message through.");
      }
    }

    // TODO: move this to a separate module
    window.onConnect = onConnect;
    window.onSendMessage = onSendMessage;

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.activeElement.blur();
      }
    });

    document.getElementById("peerid-input").addEventListener("keydown", (e) => {
      if (e.metaKey && e.key === "Enter") {
        onConnect();
      }
    });

    document
      .getElementById("message-input")
      .addEventListener("keydown", (e) => {
        if (e.metaKey && e.key === "Enter") {
          onSendMessage();
        }
      });

    document.getElementById("userslug").addEventListener("click", () => {
      const slugText = document.getElementById("userslug").textContent;
      navigator.clipboard.writeText(slugText).then(() => {
        console.log("Copied user slug to clipboard:", slugText);
        document.getElementById("userslug").textContent = "copied";
        setTimeout(() => {
          document.getElementById("userslug").textContent = slugText;
        }, 1000);
      });
    });

    window.addEventListener("beforeunload", () => {
      peer.destroy();
    });
  </script>
</html>
