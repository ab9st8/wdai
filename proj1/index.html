<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./index.css" />
    <title>charlee</title>
  </head>
  <body>
    <noscript>this app is non-functional without javascript. :(</noscript>

    <nav>
      <div id="nav-title">
        <h1>charlee</h1>
        <div id="nav-links">
          <a href="./faq.html">about this</a>
          <a href="./about.html">about me</a>
        </div>
      </div>
      <div id="userslug-container">
        you are:<br /><span id="userslug">...</span>!
      </div>
    </nav>

    <main>
      <div id="messages-container"></div>

      <div id="connection-modal">
        <input
          type="text"
          id="peerid-input"
          placeholder="enter peer ID to connect to..."
        />
        <button type="button" id="connect-button" onclick="onConnect()">
          connect
        </button>
      </div>

      <div id="message-input-container">
        <textarea
          type="text"
          id="message-input"
          rows="1"
          placeholder="type your message here..."
        ></textarea>
        <button type="button" id="send-button" onclick="onSendMessage()">
          send
        </button>
      </div>
    </main>

    <!-- TODO: add footer -->
    <!-- <footer
      style="position: fixed; bottom: 5pt; width: 100%; text-align: center; font-size: 0.8em; z-index: 1000;"
    >
      <p>Antoni Chmiela 2025. <a href="./about.html">about me</a></p>
    </footer> -->
  </body>

  <script type="module">
    import { generateSlug } from "./lib.js";
    import { Peer } from "https://esm.sh/peerjs@1.5.5?bundle-deps";

    // Set up new peer for this tab
    const slug = generateSlug();
    const peer = new Peer(slug);
    document.getElementById("userslug").textContent = peer.id;

    let connection = null;

    // Handle oncoming connections
    peer.on("connection", (conn) => {
      console.log("Incoming connection from:", conn.peer);
      conn.on("data", (data) => {
        console.log("Received:", data);
        document.getElementById("messages-container").innerHTML += `
          <div class="message received">
            <span class="message-sender">${conn.peer}:</span>
            <span class="message-text received">${data}</span>
          </div>
        `;
      });
    });

    function onConnect() {
      const modal = document.getElementById("connection-modal");
      modal.style.display = "none";
      const peerId = document.getElementById("peerid-input").value;
      const conn = peer.connect(peerId);

      conn.on("open", () => {
        console.log("Connected to:", peerId);
        connection = conn;
        document.getElementById("messages-container").innerHTML += `
          <div class="message system">
            <span class="message-text system">talking with ${peerId}!</span>
          </div>
        `;
      });
    }

    function onSendMessage() {
      const messageInput = document.getElementById("message-input");
      const message = messageInput.value;
      messageInput.value = "";

      console.log("sending message:", message);

      if (connection && connection.open) {
        connection.send(message);
        document.getElementById("messages-container").innerHTML += `
          <div class="message sent">
            <span class="message-sender">${peer.id}:</span>
            <span class="message-text sent">${message}</span>
          </div>
        `;
        document.getElementById("messages-container").innerHTML += `
          <div class="message received">
            <span class="message-sender">${conn.peer}:</span>
            <span class="message-text received">${data}</span>
          </div>
        `;
      } else {
        console.log("no open connection to send message through.");
      }
    }

    // TODO: move this to a separate module
    window.onConnect = onConnect;
    window.onSendMessage = onSendMessage;

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.activeElement.blur();
      }
    });

    document.getElementById("peerid-input").addEventListener("keydown", (e) => {
      if (e.metaKey && e.key === "Enter") {
        onConnect();
      }
    });

    document
      .getElementById("message-input")
      .addEventListener("keydown", (e) => {
        if (e.metaKey && e.key === "Enter") {
          onSendMessage();
        }
      });
  </script>
</html>
